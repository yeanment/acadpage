name: Mirror to GitLab

on: 
  push:
    branches: ["main"]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write


jobs:
  rewrite-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rewrite Git History
        run: |
          git config --global user.name "Simon HEISH"
          git config --global user.email "29884888-simonheish@users.noreply.gitlab.com"
          git filter-branch --force --env-filter '
          OLD_EMAIL="yeanment@outlook.com"
          CORRECT_NAME="Simon HEISH"
          CORRECT_EMAIL="29884888-simonheish@users.noreply.gitlab.com"

          if [ "$GIT_COMMITTER_EMAIL" = "$OLD_EMAIL" ]
          then
              export GIT_COMMITTER_NAME="$CORRECT_NAME"
              export GIT_COMMITTER_EMAIL="$CORRECT_EMAIL"
          fi
          if [ "$GIT_AUTHOR_EMAIL" = "$OLD_EMAIL" ]
          then
              export GIT_AUTHOR_NAME="$CORRECT_NAME"
              export GIT_AUTHOR_EMAIL="$CORRECT_EMAIL"
          fi
          ' --tag-name-filter cat -- --branches --tags

      - name: Push to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          REMOTE_URL="https://simonheish:${GITLAB_TOKEN}@gitlab.com/simonheish/acadpage.git"

          git remote add gitlab $REMOTE_URL
          git push gitlab main:main --force
          git push gitlab --tags --force

